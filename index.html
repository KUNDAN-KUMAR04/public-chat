<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ultra Max Global</title>
    <style>
        :root { --primary: #0084ff; --bg: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #gate { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: 0.5s; padding: 20px; }
        .opt { background: rgba(255,255,255,0.15); width: 100%; max-width: 320px; padding: 18px; border-radius: 15px; margin: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); text-align: center; }
        .nav { height: 60px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 100; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .bubble { background: #fff; padding: 10px 14px; border-radius: 18px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 8px; position: relative; }
        .my { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        #side { position: fixed; top: 0; right: -280px; width: 270px; height: 100%; background: #fff; transition: 0.3s; z-index: 1000; padding: 20px; box-shadow: -3px 0 10px rgba(0,0,0,0.1); overflow-y: auto; }
        #side.open { right: 0; }
        .bar { background: #fff; padding: 10px; border-top: 1px solid #ddd; display: flex; align-items: center; gap: 8px; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #m-in { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; outline: none; font-size: 16px; }
        #menu { display: none; position: fixed; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 12px; z-index: 2000; width: 150px; }
        .m-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
        .img-msg { width: 100%; border-radius: 12px; margin-top: 5px; cursor: pointer; }
        .big-emoji { font-size: 45px; display: block; padding: 5px 0; }
        .prog { position: fixed; bottom: 65px; left: 0; height: 3px; background: #4caf50; width: 0%; transition: 0.3s; }
    </style>
</head>
<body id="b">
    <div id="gate">
        <h1>ULTRA MAX</h1>
        <div class="opt" onclick="enter('MAX')"><b>ðŸ’Ž MAX SPACE</b><br><small>Premium 5G</small></div>
        <div class="opt" onclick="enter('SMART')"><b>ðŸ“± SMART SPACE</b><br><small>Budget Android</small></div>
        <div class="opt" onclick="enter('LITE')"><b>âš¡ LITE SPACE</b><br><small>JioPhone / Lite</small></div>
    </div>
    <div class="nav">
        <div><b>UM <span id="sp-name"></span></b> <span onclick="localStorage.removeItem('um_space');location.reload()" style="font-size:8px;opacity:0.4;cursor:pointer">RESET</span></div>
        <div style="font-size:10px;">WIPES: <span id="wipe-c">0</span></div>
        <div id="p-btn" style="cursor:pointer; font-size:22px;">ðŸ“Œ <span id="p-count" style="font-size:12px;">0</span></div>
    </div>
    <div id="side">
        <div style="display:flex; justify-content:space-between;"><h3>Special Box</h3><button onclick="document.getElementById('side').classList.remove('open')">X</button></div>
        <hr><div id="p-list"></div>
    </div>
    <div id="chat"></div>
    <div id="prog" class="prog"></div>
    <div id="menu"><div class="m-item" id="m-fwd">ðŸš€ Forward</div><div class="m-item" id="m-pin">ðŸ“Œ Pin to Box</div><div class="m-item" id="m-shr">ðŸ“¤ Share</div></div>
    <div class="bar">
        <input id="u-in" type="text" placeholder="User" style="width:45px; border:none; border-bottom:1px solid #ddd;">
        <label style="cursor:pointer; font-size:22px;">ðŸ“·<input type="file" id="f-in" style="display:none"></label>
        <input id="m-in" type="text" placeholder="Message...">
        <button id="s-btn" style="background:var(--primary); color:white; border:none; border-radius:50%; width:38px; height:38px;">âž”</button>
    </div>

    <script type="module">
        import { firebaseConfig } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const st = getStorage(app);
        let space = 'MAX', sel = null;

        window.enter = (s) => {
            space = s; document.body.className = 'space-' + s.toLowerCase();
            document.getElementById('sp-name').innerText = s;
            document.getElementById('gate').style.opacity = '0';
            setTimeout(() => document.getElementById('gate').style.display='none', 500);
            localStorage.setItem('um_space', s);
        };
        document.getElementById('p-btn').onclick = () => document.getElementById('side').classList.toggle('open');
        if(localStorage.getItem('um_space')) enter(localStorage.getItem('um_space'));

        async function send() {
            const m = document.getElementById('m-in'); if(!m.value.trim()) return;
            await addDoc(collection(db, "messages"), { user: document.getElementById('u-in').value || "Guest", txt: m.value, createdAt: serverTimestamp() });
            m.value = "";
        }
        document.getElementById('s-btn').onclick = send;

        document.getElementById('f-in').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const sRef = ref(st, 'u/' + Date.now() + "_" + file.name);
            const task = uploadBytesResumable(sRef, file);
            task.on('state_changed', (s) => { document.getElementById('prog').style.width = (s.bytesTransferred/s.totalBytes)*100 + "%"; }, null, async () => {
                const url = await getDownloadURL(task.snapshot.ref);
                await addDoc(collection(db, "messages"), { user: document.getElementById('u-in').value||"Guest", file: url, fileName: file.name, isImg: file.type.startsWith('image/'), createdAt: serverTimestamp() });
                document.getElementById('prog').style.width = "0%";
            });
        };

        window.save = async (url, name) => {
            try { const res = await fetch(url); const b = await res.blob(); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = name; a.click(); }
            catch(e) { window.open(url, '_blank'); }
        };

        onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "asc")), (snap) => {
            const chat = document.getElementById('chat'); chat.innerHTML = "";
            snap.forEach(d => {
                const data = d.data(), div = document.createElement('div');
                div.className = `bubble ${data.user === document.getElementById('u-in').value ? 'my' : ''}`;
                if(data.file) {
                    if(data.isImg && space !== 'LITE') div.innerHTML = `<img src="${data.file}" class="img-msg" onclick="save('${data.file}','img.jpg')">`;
                    else div.innerHTML = `<div style="font-size:11px;">ðŸ“„ ${data.fileName}<br><button onclick="save('${data.file}','${data.fileName}')">SAVE</button></div>`;
                } else {
                    const isEmoji = /^(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff]){1,3}$/.test(data.txt);
                    div.innerHTML = `<small>${data.user}</small><div class="${isEmoji?'big-emoji':''}">${data.txt}</div>`;
                }
                div.oncontextmenu = (e) => { e.preventDefault(); sel = data; const m = document.getElementById('menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; };
                div.ondblclick = div.oncontextmenu;
                chat.appendChild(div);
            });
            chat.scrollTop = chat.scrollHeight;
        });

        onSnapshot(collection(db, "pinned"), s => {
            document.getElementById('p-count').innerText = s.size;
            document.getElementById('p-list').innerHTML = s.docs.map(p => `<div style="background:#fff9c4; padding:8px; margin-bottom:5px; border-radius:5px; font-size:12px;">${p.data().text}</div>`).join('');
        });
        
        onSnapshot(collection(db, "stats"), s => { if(!s.empty) document.getElementById('wipe-c').innerText = s.docs[0].data().count; });

        document.getElementById('m-fwd').onclick = () => document.getElementById('m-in').value = "FWD: " + (sel.txt || sel.fileName);
        document.getElementById('m-pin').onclick = () => addDoc(collection(db, "pinned"), { text: sel.txt || sel.fileName });
        window.onclick = () => document.getElementById('menu').style.display='none';
    </script>
</body>
</html>
