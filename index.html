<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ultra Max Global Chat</title>
    
    <link rel="manifest" href="manifest.json">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default%2Ces2015%2Ces2016%2Ces2017"></script>

    <style>
        :root { --primary: #0084ff; --bg: #f0f2f5; --accent: #ff4081; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER & LEVEL SYSTEM */
        .nav { height: 50px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 100; }
        .lvl { font-size: 10px; font-weight: bold; padding: 3px 10px; border-radius: 12px; }
        .lvl-n { background: #4caf50; color: white; }
        .lvl-m { background: #f44336; color: white; box-shadow: 0 0 8px rgba(244,67,54,0.4); animation: pulse 2s infinite; }

        /* CHAT & THREADING */
        #chat { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .msg-unit { margin-bottom: 15px; clear: both; }
        .bubble { background: #fff; padding: 12px; border-radius: 18px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; display: inline-block; }
        .my { float: right; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .reply-node { margin-left: 20px; border-left: 2px solid #ddd; padding-left: 10px; margin-top: 8px; }

        /* REACTIONS & ACTIONS */
        .actions { display: flex; gap: 10px; margin-top: 5px; font-size: 11px; font-weight: bold; color: var(--primary); }
        .react-pill { cursor: pointer; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 10px; }

        /* PINNED SIDEBAR */
        #side { position: fixed; top: 0; right: -280px; width: 270px; height: 100%; background: #fff; box-shadow: -3px 0 10px rgba(0,0,0,0.1); transition: 0.3s; z-index: 1000; padding: 20px; }
        #side.open { right: 0; }

        /* INPUT AREA */
        .bar { background: #fff; padding: 10px; border-top: 1px solid #ddd; display: flex; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #m-in { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* JIO / LEGACY OVERRIDE */
        .legacy .bubble { border: 1px solid #ccc; box-shadow: none; border-radius: 5px; }
        .legacy .lvl-m { animation: none; }
    </style>
</head>
<body id="b">

    <div class="nav">
        <div id="stat" class="lvl lvl-n">LEVEL: NORMAL</div>
        <div style="font-size: 11px;">WIPES: <span id="w-counter" style="color:red">0</span></div>
        <div onclick="toggleS()" style="cursor:pointer; position:relative;">
            üìå <span id="p-badge" style="position:absolute; top:-5px; right:-8px; background:red; color:white; font-size:9px; border-radius:50%; width:15px; height:15px; display:flex; align-items:center; justify-content:center;">0</span>
        </div>
    </div>

    <div id="side">
        <div style="display:flex; justify-content:space-between;"><h3>Special Box</h3><b onclick="toggleS()">‚úñ</b></div>
        <hr><div id="p-list"></div>
    </div>

    <div id="chat"></div>

    <div class="bar">
        <input id="u-in" type="text" placeholder="User" style="width:50px; border:none; border-bottom:1px solid #ddd; margin-right:5px;">
        <input id="m-in" type="text" placeholder="Type..." onkeydown="if(event.keyCode==13)send()">
        <button onclick="send()" style="background:var(--primary); color:white; border:none; border-radius:50%; width:40px; height:40px; margin-left:8px;">‚ûî</button>
    </div>

    <script type="module">
        // 1. ADAPTIVE LOADER
        if(!window.fetch || !window.Promise) document.getElementById('b').className = "legacy";

        import { firebaseConfig } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const chat = document.getElementById('chat');
        let rId = null;

        // 2. FEATURE SYNC (Threads + Levels + Reactions)
        onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "asc")), (snap) => {
            chat.innerHTML = "";
            const all = snap.docs;
            
            // Level logic
            const s = document.getElementById('stat');
            if(all.length > 100) { s.className = "lvl lvl-m"; s.innerText = "LEVEL: MAX"; }
            else { s.className = "lvl lvl-n"; s.innerText = "LEVEL: NORMAL"; }

            all.forEach(d => {
                if(!d.data().replyTo) chat.appendChild(buildNode(d, all));
            });
            chat.scrollTop = chat.scrollHeight;
        });

        function buildNode(d, all) {
            const data = d.data();
            const node = document.createElement('div');
            node.className = "msg-unit";
            const isMe = data.user === document.getElementById('u-in').value;
            
            node.innerHTML = `
                <div class="bubble ${isMe?'my':''}">
                    <div style="font-size:9px; opacity:0.6">${data.user}</div>
                    <div>${data.text}</div>
                    <div class="actions">
                        <span class="react-pill" onclick="window.like('${d.id}')">‚ù§Ô∏è ${data.likes||0}</span>
                        <span style="cursor:pointer" onclick="window.rep('${d.id}','${data.user}')">Reply</span>
                    </div>
                </div>`;

            all.forEach(r => {
                if(r.data().replyTo === d.id) {
                    const res = document.createElement('div');
                    res.className = "reply-node";
                    res.appendChild(buildNode(r, all));
                    node.appendChild(res);
                }
            });
            return node;
        }

        // 3. ACTIONS
        window.rep = (id, name) => { rId = id; document.getElementById('m-in').placeholder = "To " + name; };
        window.like = async (id) => { await updateDoc(doc(db, "messages", id), { likes: increment(1) }); };

        window.send = async () => {
            const m = document.getElementById('m-in');
            if(!m.value) return;
            await addDoc(collection(db, "messages"), {
                user: document.getElementById('u-in').value || "Guest",
                text: m.value,
                replyTo: rId,
                likes: 0,
                createdAt: serverTimestamp()
            });
            m.value = ""; rId = null; m.placeholder = "Type...";
        };

        window.toggleS = () => document.getElementById('side').classList.toggle('open');

        // Stats & Pinned
        onSnapshot(collection(db, "pinned"), s => {
            document.getElementById('p-badge').innerText = s.size;
            document.getElementById('p-list').innerHTML = s.docs.map(p => `<div style="background:#fff9c4; padding:8px; margin-bottom:5px; border-radius:5px; font-size:12px;">${p.data().text}</div>`).join('');
        });
        onSnapshot(doc(db, "admin", "stats"), d => { if(d.exists()) document.getElementById('w-counter').innerText = d.data().wipes; });

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
