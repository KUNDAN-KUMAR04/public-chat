<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ultra Max Global | 2026 Edition</title>
    <style>
        :root { 
            --primary: #0084ff; 
            --bg: #f0f2f5; 
            --my-bubble: #0084ff; 
            --other-bubble: #ffffff;
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* --- HARDWARE SELECTION GATE --- */
        #gate { 
            position: fixed; 
            inset: 0; 
            background: var(--primary); 
            z-index: 10000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }
        
        .gate-content { width: 90%; max-width: 400px; }
        .opt-card { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 20px;
            margin: 12px 0;
            cursor: pointer;
            transition: 0.3s;
            backdrop-filter: blur(10px);
        }
        .opt-card:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-3px); }
        .opt-card b { display: block; font-size: 18px; margin-bottom: 5px; }
        .opt-card small { opacity: 0.8; font-size: 12px; }

        /* --- HEADER --- */
        .header { 
            height: 65px; 
            background: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .header .logo { font-weight: 800; font-size: 20px; color: var(--primary); cursor: pointer; }
        .header .stats { text-align: center; line-height: 1.2; }
        .header .stats span { display: block; font-size: 10px; color: #888; text-transform: uppercase; }
        .header .stats b { font-size: 14px; color: #333; }

        /* --- CHAT ENGINE --- */
        #chat { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            background: #e5ddd5; /* Classic chat background texture feel */
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }

        .msg { 
            max-width: 80%; 
            padding: 10px 14px; 
            border-radius: 15px; 
            font-size: 15px; 
            position: relative; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .msg.my { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; color: #000; }
        .msg.other { align-self: flex-start; background: #fff; border-bottom-left-radius: 2px; }
        
        .msg .user-tag { font-size: 11px; font-weight: 700; color: var(--primary); margin-bottom: 4px; display: block; }
        .msg .reply-quote { 
            background: rgba(0,0,0,0.05); 
            border-left: 4px solid var(--primary); 
            padding: 6px; 
            border-radius: 4px; 
            margin-bottom: 8px; 
            font-size: 12px; 
            color: #555;
        }

        /* --- MEDIA HANDLING --- */
        .file-box { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(0,0,0,0.03); 
            padding: 10px; 
            border-radius: 10px; 
            cursor: pointer;
            margin-top: 5px;
        }
        .file-box:hover { background: rgba(0,0,0,0.06); }
        .img-preview { width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; display: block; }

        /* --- SIDEBAR (SPECIAL BOX) --- */
        #special-box { 
            position: fixed; 
            top: 0; 
            right: -320px; 
            width: 300px; 
            height: 100%; 
            background: #fff; 
            z-index: 2000; 
            transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); 
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #special-box.open { right: 0; }
        .sb-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .sb-list { flex: 1; overflow-y: auto; padding: 15px; }
        .pin-item { background: #fdfae6; border: 1px solid #f1e05a; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 13px; }

        /* --- INPUT SYSTEM --- */
        .input-area { 
            background: #f0f0f0; 
            padding: 10px 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .input-wrapper { flex: 1; background: #fff; border-radius: 25px; padding: 5px 15px; display: flex; align-items: center; border: 1px solid #ddd; }
        #m-in { flex: 1; border: none; padding: 10px; font-size: 16px; background: transparent; }
        
        /* --- CONTEXT MENU --- */
        #context-menu { 
            display: none; 
            position: fixed; 
            background: var(--glass); 
            backdrop-filter: blur(15px);
            border-radius: 15px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); 
            z-index: 5000; 
            width: 180px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .cm-item { padding: 14px 18px; cursor: pointer; font-size: 14px; border-bottom: 1px solid rgba(0,0,0,0.05); transition: 0.2s; }
        .cm-item:hover { background: rgba(0,0,0,0.05); }

        /* --- PROGRESS & NOTIFS --- */
        .loader { position: fixed; top: 0; left: 0; height: 3px; background: #4caf50; width: 0%; z-index: 10001; transition: 0.3s; }
    </style>
</head>
<body>

<div id="loader" class="loader"></div>

<div id="gate">
    <div class="gate-content">
        <h1 style="font-size: 40px; margin-bottom: 10px;">ULTRA MAX</h1>
        <p style="margin-bottom: 30px; opacity: 0.9;">Global 5G Communication Protocol</p>
        
        <div class="opt-card" onclick="launch('MAX')">
            <b>üíé MAX ENGINE</b>
            <small>High-End PC / 5G / Full HD Media Previews</small>
        </div>
        
        <div class="opt-card" onclick="launch('SMART')">
            <b>üì± SMART ENGINE</b>
            <small>Android / 4G / Balanced Performance</small>
        </div>
        
        <div class="opt-card" onclick="launch('LITE')">
            <b>‚ö° LITE ENGINE</b>
            <small>JioPhone / 2G-3G / Text-Only / Low RAM</small>
        </div>
    </div>
</div>

<div class="header">
    <div class="logo" onclick="location.reload()">UM GLOBAL</div>
    <div class="stats">
        <span>Global Wipes</span>
        <b id="wipe-display">0</b>
    </div>
    <div id="pin-trigger" style="cursor:pointer; font-size: 24px; position: relative;">
        üìå<span id="pin-badge" style="position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:10px; border-radius:50%; width:18px; height:18px; display:flex; items-center; justify-content:center; display:none;">0</span>
    </div>
</div>

<div id="special-box">
    <div class="sb-header">
        <h3 style="margin:0">Special Box</h3>
        <button onclick="toggleSidebar()" style="background:none; border:none; font-size:20px; cursor:pointer;">‚úï</button>
    </div>
    <div class="sb-list" id="pin-list"></div>
</div>

<div id="chat"></div>

<div id="reply-bar" style="display:none; background:#eee; padding:10px; border-top:1px solid #ddd; font-size:12px; display:flex; justify-content:space-between;">
    <div id="reply-text"></div>
    <div onclick="cancelReply()" style="cursor:pointer; font-weight:bold;">‚úï</div>
</div>

<div id="context-menu">
    <div class="cm-item" id="cm-reply">üí¨ Reply Message</div>
    <div class="cm-item" id="cm-pin">üìå Pin to Special Box</div>
    <div class="cm-item" id="cm-copy">üìù Copy Text</div>
    <div class="cm-item" id="cm-save" style="color:var(--primary); font-weight:bold;">üì• Save to Device</div>
</div>

<div class="input-area">
    <input id="user-name" type="text" placeholder="User" style="width:60px; border:none; border-radius:15px; padding:8px; text-align:center; font-size:12px; background:#fff;">
    <label style="cursor:pointer; font-size: 24px;">üìÅ<input type="file" id="file-input" style="display:none"></label>
    <div class="input-wrapper">
        <input id="m-in" type="text" placeholder="Type message...">
    </div>
    <button id="send-btn" style="background:var(--primary); border:none; color:white; width:45px; height:45px; border-radius:50%; font-size:20px; cursor:pointer;">‚ûî</button>
</div>

<script type="module">
    import { firebaseConfig } from './config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const st = getStorage(app);

    let engineMode = 'MAX';
    let selectedMsg = null;
    let replyPayload = null;

    // --- ENGINE LAUNCHER ---
    window.launch = (mode) => {
        engineMode = mode;
        localStorage.setItem('um_mode', mode);
        document.getElementById('gate').style.transform = 'translateY(-100%)';
        setTimeout(() => document.getElementById('gate').style.display = 'none', 600);
        runEngine();
    };

    if(localStorage.getItem('um_mode')) launch(localStorage.getItem('um_mode'));

    // --- CHAT ENGINE ---
    function runEngine() {
        // Device-Specific Throttling
        const limits = { 'LITE': 20, 'SMART': 50, 'MAX': 150 };
        const q = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(limits[engineMode]));

        onSnapshot(q, (snap) => {
            const chat = document.getElementById('chat');
            chat.innerHTML = "";
            const msgs = [];
            snap.forEach(d => msgs.push({id: d.id, ...d.data()}));
            
            msgs.reverse().forEach(data => {
                const bubble = document.createElement('div');
                const isMe = data.user === (document.getElementById('user-name').value || "Guest");
                bubble.className = `msg ${isMe ? 'my' : 'other'}`;
                
                let content = `<span class="user-tag">${data.user}</span>`;
                
                if(data.reply) content += `<div class="reply-quote">${data.reply}</div>`;

                if(data.file) {
                    if(data.isImg && engineMode !== 'LITE') {
                        content += `<img src="${data.file}" class="img-preview" onclick="downloadAsset('${data.file}', '${data.fileName}')">`;
                    } else {
                        content += `
                            <div class="file-box" onclick="downloadAsset('${data.file}', '${data.fileName}')">
                                <span style="font-size:24px;">üìÑ</span>
                                <div style="overflow:hidden">
                                    <div style="font-weight:bold; font-size:12px; white-space:nowrap; text-overflow:ellipsis;">${data.fileName}</div>
                                    <small style="opacity:0.6;">Click to save to device</small>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    content += `<div>${data.txt}</div>`;
                }

                bubble.innerHTML = content;

                // Long Press / Right Click for Context Menu
                const openMenu = (e) => {
                    e.preventDefault();
                    selectedMsg = data;
                    const menu = document.getElementById('context-menu');
                    menu.style.display = 'block';
                    menu.style.left = Math.min(e.pageX, window.innerWidth - 200) + 'px';
                    menu.style.top = Math.min(e.pageY, window.innerHeight - 250) + 'px';
                };
                bubble.oncontextmenu = openMenu;
                bubble.ondblclick = openMenu;

                chat.appendChild(bubble);
            });
            chat.scrollTop = chat.scrollHeight;
        });

        // Sync Global Stats
        onSnapshot(collection(db, "stats"), s => {
            if(!s.empty) document.getElementById('wipe-display').innerText = s.docs[0].data().count || 0;
        });

        // Sync Special Box
        onSnapshot(collection(db, "pinned"), s => {
            const list = document.getElementById('pin-list');
            const badge = document.getElementById('pin-badge');
            list.innerHTML = "";
            badge.innerText = s.size;
            badge.style.display = s.size > 0 ? 'flex' : 'none';
            
            s.docs.forEach(p => {
                const item = document.createElement('div');
                item.className = 'pin-item';
                item.innerHTML = `<b>${p.data().by}:</b><br>${p.data().text}`;
                list.appendChild(item);
            });
        });
    }

    // --- ASSET DOWNLOAD BRIDGE ---
    window.downloadAsset = async (url, name) => {
        const prog = document.getElementById('loader');
        prog.style.width = "40%";
        try {
            const res = await fetch(url);
            const blob = await res.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = name || "UM_Download";
            link.click();
            prog.style.width = "100%";
            setTimeout(() => prog.style.width = "0%", 1000);
        } catch (e) { window.open(url, '_blank'); }
    };

    // --- CORE ACTIONS ---
    async function sendMessage() {
        const input = document.getElementById('m-in');
        if(!input.value.trim()) return;
        
        await addDoc(collection(db, "messages"), {
            user: document.getElementById('user-name').value || "Guest",
            txt: input.value,
            reply: replyPayload,
            createdAt: serverTimestamp()
        });
        
        input.value = "";
        cancelReply();
    }

    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('m-in').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    // File Upload Logic
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const prog = document.getElementById('loader');
        const sRef = ref(st, 'uploads/' + Date.now() + "_" + file.name);
        const task = uploadBytesResumable(sRef, file);

        task.on('state_changed', (s) => {
            prog.style.width = (s.bytesTransferred / s.totalBytes) * 100 + "%";
        }, (err) => alert(err), async () => {
            const url = await getDownloadURL(task.snapshot.ref);
            await addDoc(collection(db, "messages"), {
                user: document.getElementById('user-name').value || "Guest",
                file: url,
                fileName: file.name,
                isImg: file.type.startsWith('image/'),
                createdAt: serverTimestamp()
            });
            prog.style.width = "0%";
        });
    };

    // --- UI HELPERS ---
    window.toggleSidebar = () => document.getElementById('special-box').classList.toggle('open');
    document.getElementById('pin-trigger').onclick = toggleSidebar;

    window.cancelReply = () => {
        replyPayload = null;
        document.getElementById('reply-bar').style.display = 'none';
    };

    // Context Menu Handlers
    document.getElementById('cm-reply').onclick = () => {
        replyPayload = selectedMsg.txt || "Attached Media";
        document.getElementById('reply-text').innerText = "Replying to: " + replyPayload;
        document.getElementById('reply-bar').style.display = 'flex';
    };

    document.getElementById('cm-pin').onclick = () => {
        addDoc(collection(db, "pinned"), {
            text: selectedMsg.txt || selectedMsg.fileName,
            by: selectedMsg.user
        });
    };

    document.getElementById('cm-copy').onclick = () => {
        navigator.clipboard.writeText(selectedMsg.txt || selectedMsg.file);
        alert("Copied to clipboard!");
    };

    document.getElementById('cm-save').onclick = () => {
        if(selectedMsg.file) downloadAsset(selectedMsg.file, selectedMsg.fileName);
        else alert("This is a text message.");
    };

    window.onclick = () => document.getElementById('context-menu').style.display = 'none';

</script>
</body>
</html>
