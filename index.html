<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0084ff">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5962/5962463.png">
    <link rel="manifest" href="manifest.json">

    <title>Ultra Max Global</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default%2Ces2015%2Ces2016%2Ces2017"></script>

    <style>
        :root { --primary: #0084ff; --bg: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER: Status & Level */
        .top-nav { height: 60px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 20px 15px 5px; z-index: 100; }
        .lvl { font-size: 10px; font-weight: bold; padding: 3px 10px; border-radius: 12px; color: white; }
        .lvl-n { background: #4caf50; }
        .lvl-m { background: #f44336; box-shadow: 0 0 8px rgba(244,67,54,0.3); }

        /* CHAT AREA: Threaded & Adaptive */
        #chat { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .unit { margin-bottom: 12px; clear: both; display: flex; flex-direction: column; }
        .bubble { background: #fff; padding: 12px; border-radius: 18px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .my { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .reply-node { margin-left: 20px; border-left: 2px solid #ddd; padding-left: 10px; margin-top: 5px; }

        /* BUTTONS & REACTIONS */
        .act { display: flex; gap: 10px; margin-top: 5px; font-size: 11px; font-weight: bold; color: var(--primary); }
        .re { cursor: pointer; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 8px; }

        /* SIDEBAR: Pinned Box */
        #side { position: fixed; top: 0; right: -280px; width: 270px; height: 100%; background: #fff; box-shadow: -3px 0 10px rgba(0,0,0,0.1); transition: 0.3s; z-index: 1000; padding: 20px; }
        #side.open { right: 0; }

        /* INPUT: Optimized for Keypad/Jio */
        .input-bar { background: #fff; padding: 10px; border-top: 1px solid #ddd; display: flex; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #m-in { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; }

        /* LEGACY MODE: (Auto-triggered for Jio/Old Android) */
        .legacy .bubble { border: 1px solid #ccc; box-shadow: none; border-radius: 5px; }
    </style>
</head>
<body id="main">

    <div class="top-nav">
        <div id="status" class="lvl lvl-n">LEVEL: NORMAL</div>
        <div style="font-size: 11px; font-weight: bold;">WIPES: <span id="wipe-c" style="color:red">0</span></div>
        <div onclick="toggleS()" style="cursor:pointer; position:relative; font-size:20px;">
            üìå <span id="p-badge" style="position:absolute; top:-5px; right:-8px; background:red; color:white; font-size:9px; border-radius:50%; width:16px; height:16px; display:flex; align-items:center; justify-content:center;">0</span>
        </div>
    </div>

    <div id="side">
        <div style="display:flex; justify-content:space-between;"><h3>Special Box</h3><b onclick="toggleS()" style="cursor:pointer">‚úñ</b></div>
        <hr><div id="p-list"></div>
    </div>

    <div id="chat"></div>

    <div class="input-bar">
        <input id="u-in" type="text" placeholder="Name" style="width:55px; border:none; border-bottom:1px solid #ddd; margin-right:5px;">
        <input id="m-in" type="text" placeholder="Message..." onkeydown="if(event.keyCode==13)send()">
        <button onclick="send()" style="background:var(--primary); color:white; border:none; border-radius:50%; width:40px; height:40px; margin-left:8px; cursor:pointer;">‚ûî</button>
    </div>

    <script type="module">
        // --- 1. DETECTION ---
        if(!window.fetch || !window.Promise) document.getElementById('main').className = "legacy";

        import { firebaseConfig } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const chatBox = document.getElementById('chat');
        let rTarget = null;

        // --- 2. THE ENGINE ---
        onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "asc")), (snap) => {
            chatBox.innerHTML = "";
            const all = snap.docs;
            
            // Level Update
            const st = document.getElementById('status');
            if(all.length > 100) { st.className="lvl lvl-m"; st.innerText="LEVEL: MAX"; }
            else { st.className="lvl lvl-n"; st.innerText="LEVEL: NORMAL"; }

            // Render Threads
            all.forEach(d => {
                if(!d.data().replyTo) chatBox.appendChild(createUnit(d, all));
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        function createUnit(d, all) {
            const data = d.data();
            const div = document.createElement('div');
            div.className = "unit";
            const isMe = data.user === document.getElementById('u-in').value;
            
            div.innerHTML = `
                <div class="bubble ${isMe?'my':''}">
                    <div style="font-size:9px; opacity:0.6">${data.user}</div>
                    <div>${data.text}</div>
                    <div class="act">
                        <span class="re" onclick="window.like('${d.id}')">‚ù§Ô∏è ${data.likes||0}</span>
                        <span style="cursor:pointer" onclick="window.reply('${d.id}','${data.user}')">Reply</span>
                    </div>
                </div>`;

            all.forEach(r => {
                if(r.data().replyTo === d.id) {
                    const node = document.createElement('div');
                    node.className = "reply-node";
                    node.appendChild(createUnit(r, all));
                    div.appendChild(node);
                }
            });
            return div;
        }

        // --- 3. GLOBAL ACTIONS ---
        window.reply = (id, name) => { rTarget = id; document.getElementById('m-in').placeholder = "Replying to " + name; document.getElementById('m-in').focus(); };
        window.like = async (id) => { await updateDoc(doc(db, "messages", id), { likes: increment(1) }); };
        window.toggleS = () => document.getElementById('side').classList.toggle('open');

        window.send = async () => {
            const m = document.getElementById('m-in');
            if(!m.value) return;
            await addDoc(collection(db, "messages"), {
                user: document.getElementById('u-in').value || "Guest",
                text: m.value,
                replyTo: rTarget,
                likes: 0,
                createdAt: serverTimestamp()
            });
            m.value = ""; rTarget = null; m.placeholder = "Message...";
        };

        // --- 4. STATS & PINNED ---
        onSnapshot(collection(db, "pinned"), s => {
            document.getElementById('p-badge').innerText = s.size;
            document.getElementById('p-list').innerHTML = s.docs.map(p => `<div style="background:#fff9c4; padding:8px; margin-bottom:5px; border-radius:8px; font-size:12px;">${p.data().text}</div>`).join('');
        });
        onSnapshot(doc(db, "admin", "stats"), d => { if(d.exists()) document.getElementById('wipe-c').innerText = d.data().wipes; });

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
