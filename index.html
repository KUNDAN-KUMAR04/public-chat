<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0084ff">
    <link rel="manifest" href="manifest.json">
    <title>Ultra Max Global</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default%2Ces2015%2Ces2016%2Ces2017"></script>

    <style>
        :root { --primary: #0084ff; --bg: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .top-nav { height: 60px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 20px 15px 5px; z-index: 100; }
        .lvl { font-size: 10px; font-weight: bold; padding: 3px 10px; border-radius: 12px; color: white; }
        .lvl-n { background: #4caf50; }
        .lvl-m { background: #f44336; }

        /* CHAT */
        #chat { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .unit { margin-bottom: 12px; display: flex; flex-direction: column; }
        .bubble { background: #fff; padding: 12px; border-radius: 18px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .my { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .reply-node { margin-left: 20px; border-left: 2px solid #ddd; padding-left: 10px; margin-top: 5px; }

        /* SIDEBAR (PINNED) */
        #side { position: fixed; top: 0; right: -280px; width: 270px; height: 100%; background: #fff; box-shadow: -3px 0 10px rgba(0,0,0,0.1); transition: transform 0.3s ease; z-index: 1000; padding: 20px; visibility: hidden; }
        #side.open { transform: translateX(-280px); visibility: visible; }

        /* INPUT */
        .input-bar { background: #fff; padding: 10px; border-top: 1px solid #ddd; display: flex; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #m-in { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; }
        button#send-btn { background: var(--primary); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 8px; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body id="main">

    <div class="top-nav">
        <div id="status" class="lvl lvl-n">LEVEL: NORMAL</div>
        <div style="font-size: 11px; font-weight: bold;">WIPES: <span id="wipe-c">0</span></div>
        <div id="pin-toggle" style="cursor:pointer; position:relative; font-size:22px;">
            ðŸ“Œ <span id="p-badge" style="position:absolute; top:-5px; right:-8px; background:red; color:white; font-size:9px; border-radius:50%; width:16px; height:16px; display:flex; align-items:center; justify-content:center;">0</span>
        </div>
    </div>

    <div id="side">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Special Box</h3>
            <span id="close-side" style="cursor:pointer; font-size:24px;">Ã—</span>
        </div>
        <hr><div id="p-list"></div>
    </div>

    <div id="chat"></div>

    <div class="input-bar">
        <input id="u-in" type="text" placeholder="User" style="width:60px; border:none; border-bottom:1px solid #ddd; margin-right:5px;">
        <input id="m-in" type="text" placeholder="Message...">
        <button id="send-btn">âž”</button>
    </div>

    <script type="module">
        import { firebaseConfig } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const chatBox = document.getElementById('chat');
        let rTarget = null;

        // --- FIXED BUTTON LOGIC (Direct Listeners) ---
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('m-in').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        document.getElementById('pin-toggle').addEventListener('click', toggleSidebar);
        document.getElementById('close-side').addEventListener('click', toggleSidebar);

        function toggleSidebar() {
            document.getElementById('side').classList.toggle('open');
        }

        async function sendMessage() {
            const m = document.getElementById('m-in');
            const u = document.getElementById('u-in');
            if(!m.value.trim()) return;
            
            try {
                await addDoc(collection(db, "messages"), {
                    user: u.value || "Guest",
                    text: m.value,
                    replyTo: rTarget,
                    likes: 0,
                    createdAt: serverTimestamp()
                });
                m.value = ""; 
                rTarget = null; 
                m.placeholder = "Message...";
            } catch(e) { console.error("Send failed", e); }
        }

        // --- REAL-TIME UPDATES ---
        onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "asc")), (snap) => {
            chatBox.innerHTML = "";
            snap.docs.forEach(d => {
                if(!d.data().replyTo) chatBox.appendChild(createMessageElement(d, snap.docs));
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        function createMessageElement(d, all) {
            const data = d.data();
            const container = document.createElement('div');
            container.className = "unit";
            const isMe = data.user === document.getElementById('u-in').value;
            
            const bubble = document.createElement('div');
            bubble.className = `bubble ${isMe ? 'my' : ''}`;
            bubble.innerHTML = `<div style="font-size:9px; opacity:0.6">${data.user}</div><div>${data.text}</div>`;
            
            // Interaction Bar
            const actions = document.createElement('div');
            actions.className = "act";
            actions.style.display = "flex"; actions.style.gap = "10px"; actions.style.marginTop = "5px"; actions.style.fontSize = "11px";
            
            const likeBtn = document.createElement('span');
            likeBtn.innerHTML = `â¤ï¸ ${data.likes || 0}`;
            likeBtn.style.cursor = "pointer";
            likeBtn.onclick = () => updateDoc(doc(db, "messages", d.id), { likes: increment(1) });
            
            const replyBtn = document.createElement('span');
            replyBtn.innerText = "Reply";
            replyBtn.style.cursor = "pointer";
            replyBtn.onclick = () => { 
                rTarget = d.id; 
                document.getElementById('m-in').placeholder = "To " + data.user;
                document.getElementById('m-in').focus();
            };

            actions.append(likeBtn, replyBtn);
            bubble.appendChild(actions);
            container.appendChild(bubble);

            // Nested Replies
            all.forEach(r => {
                if(r.data().replyTo === d.id) {
                    const replyNode = document.createElement('div');
                    replyNode.className = "reply-node";
                    replyNode.appendChild(createMessageElement(r, all));
                    container.appendChild(replyNode);
                }
            });

            return container;
        }

        // Stats & Pins
        onSnapshot(collection(db, "pinned"), s => {
            document.getElementById('p-badge').innerText = s.size;
            document.getElementById('p-list').innerHTML = s.docs.map(p => `<div style="background:#fff9c4; padding:10px; margin-bottom:10px; border-radius:8px;">${p.data().text}</div>`).join('');
        });
        onSnapshot(doc(db, "admin", "stats"), d => { if(d.exists()) document.getElementById('wipe-c').innerText = d.data().wipes; });
    </script>
</body>
</html>
