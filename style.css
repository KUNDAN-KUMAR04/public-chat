/* ═══════════════════════════════════════════════════════════════════════
   ULTRA MAX GLOBAL — Main Stylesheet
   Uses CSS custom properties for light/dark theme switching
═══════════════════════════════════════════════════════════════════════ */

/* ── Reset ──────────────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ── Design tokens — Light theme ──────────────────────────────────── */
:root {
    --primary:        #0084ff;
    --primary-dark:   #0060c0;
    --primary-light:  #e8f0fe;

    --bg:             #f0f2f5;
    --surface:        #ffffff;
    --surface-2:      #f7f8fa;
    --border:         #e4e6ea;

    --text:           #1c1e21;
    --text-2:         #65676b;
    --text-3:         #90949c;

    --shadow-sm:      0 1px 3px rgba(0,0,0,.08);
    --shadow-md:      0 4px 12px rgba(0,0,0,.12);
    --shadow-lg:      0 8px 24px rgba(0,0,0,.16);

    --radius-sm:      6px;
    --radius-md:      12px;
    --radius-lg:      18px;
    --radius-xl:      24px;

    --bubble-mine:    #0084ff;
    --bubble-theirs:  #ffffff;
    --text-mine:      #ffffff;
    --text-theirs:    #1c1e21;

    --nav-h:          56px;
    --input-h:        60px;

    --transition:     0.2s ease;
}

/* ── Dark theme ─────────────────────────────────────────────────────── */
[data-theme="dark"] {
    --bg:             #18191a;
    --surface:        #242526;
    --surface-2:      #3a3b3c;
    --border:         #3e4042;

    --text:           #e4e6eb;
    --text-2:         #b0b3b8;
    --text-3:         #8a8d91;

    --shadow-sm:      0 1px 3px rgba(0,0,0,.3);
    --shadow-md:      0 4px 12px rgba(0,0,0,.4);

    --bubble-theirs:  #3a3b3c;
    --text-theirs:    #e4e6eb;
    --primary-light:  #1c2f4a;
}

/* ── Base ────────────────────────────────────────────────────────────── */
html { height: 100%; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                 'Apple Color Emoji', 'Segoe UI Emoji', Arial, sans-serif;
    background:  var(--bg);
    color:       var(--text);
    height:      100%;
    display:     flex;
    flex-direction: column;
    overflow:    hidden;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: transparent;
}

input, button, textarea { font-family: inherit; color: inherit; }
button { cursor: pointer; border: none; background: none; }
a { color: var(--primary); }

/* ── Gate ────────────────────────────────────────────────────────────── */
#gate {
    position:    fixed;
    inset:       0;
    background:  linear-gradient(150deg, #0070e0 0%, #0040a0 100%);
    z-index:     10000;
    display:     flex;
    align-items: center;
    justify-content: center;
    padding:     20px;
    transform:   translateY(0);
    transition:  transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
}

.gate-logo {
    font-size: 56px;
    text-align: center;
    margin-bottom: 8px;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,.3));
}

.gate-title {
    color:       #fff;
    font-size:   28px;
    font-weight: 800;
    text-align:  center;
    letter-spacing: -0.5px;
}

.gate-subtitle {
    color:       rgba(255,255,255,.75);
    font-size:   14px;
    text-align:  center;
    margin:      6px 0 28px;
}

.gate-content { width: 100%; max-width: 380px; }

.tier {
    display:        flex;
    align-items:    center;
    gap:            14px;
    width:          100%;
    padding:        18px 20px;
    margin-bottom:  12px;
    background:     rgba(255,255,255,.12);
    border:         2px solid rgba(255,255,255,.2);
    border-radius:  var(--radius-lg);
    color:          #fff;
    text-align:     left;
    transition:     all var(--transition);
    backdrop-filter: blur(8px);
}

.tier:hover  { background: rgba(255,255,255,.22); transform: translateY(-2px); box-shadow: var(--shadow-md); }
.tier:active { transform: scale(0.98); }

.tier-icon { font-size: 28px; flex-shrink: 0; }
.tier-info strong { display: block; font-size: 17px; font-weight: 700; }
.tier-info small  { font-size: 12px; opacity: .85; margin-top: 2px; display: block; }

/* ── Nav ─────────────────────────────────────────────────────────────── */
.nav {
    height:          var(--nav-h);
    display:         flex;
    align-items:     center;
    justify-content: space-between;
    padding:         0 12px;
    background:      var(--surface);
    border-bottom:   1px solid var(--border);
    box-shadow:      var(--shadow-sm);
    flex-shrink:     0;
    z-index:         100;
    gap:             8px;
}

.nav-left  { display: flex; align-items: center; gap: 6px; }
.nav-right { display: flex; align-items: center; gap: 6px; }
.nav-center { text-align: center; font-size: 11px; color: var(--text-2); line-height: 1.3; }
.nav-center strong { display: block; font-size: 16px; color: var(--text); }

.nav-logo  { font-size: 18px; font-weight: 800; color: var(--primary); }
.nav-name  { font-size: 13px; font-weight: 600; color: var(--text-2); }

.nav-icon-btn {
    width:         36px;
    height:        36px;
    border-radius: 50%;
    font-size:     18px;
    display:       flex;
    align-items:   center;
    justify-content: center;
    transition:    background var(--transition);
    color:         var(--text-2);
}
.nav-icon-btn:hover { background: var(--surface-2); }

.level-btn {
    background:    var(--primary);
    color:         #fff;
    padding:       6px 12px;
    border-radius: var(--radius-sm);
    font-size:     12px;
    font-weight:   700;
    transition:    background var(--transition);
}
.level-btn:hover { background: var(--primary-dark); }

/* ── Sidebar ─────────────────────────────────────────────────────────── */
.sidebar {
    position:   fixed;
    top:        0;
    right:      -100%;
    width:      min(320px, 88vw);
    height:     100%;
    background: var(--surface);
    border-left: 1px solid var(--border);
    box-shadow:  var(--shadow-lg);
    z-index:    4000;
    display:    flex;
    flex-direction: column;
    padding:    0;
    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.sidebar.open { right: 0; }

.sidebar-backdrop {
    position:   fixed;
    inset:      0;
    background: rgba(0,0,0,.4);
    z-index:    3999;
    display:    none;
    opacity:    0;
    transition: opacity 0.3s;
}
.sidebar.open ~ .sidebar-backdrop { display: block; opacity: 1; }

.sidebar-header {
    display:        flex;
    align-items:    center;
    justify-content: space-between;
    padding:        16px;
    border-bottom:  1px solid var(--border);
    flex-shrink:    0;
}
.sidebar-header h3 { font-size: 16px; font-weight: 700; }
.sidebar-close {
    font-size: 20px;
    color:     var(--text-2);
    padding:   4px 8px;
    border-radius: var(--radius-sm);
    transition: background var(--transition);
}
.sidebar-close:hover { background: var(--surface-2); }

.pin-list {
    flex:       1;
    overflow-y: auto;
    padding:    8px;
}

.pin-empty {
    color:      var(--text-3);
    text-align: center;
    padding:    40px 16px;
    font-size:  14px;
    line-height: 1.6;
}

.pin-item {
    display:        flex;
    align-items:    flex-start;
    gap:            8px;
    padding:        10px;
    border-radius:  var(--radius-md);
    transition:     background var(--transition);
    margin-bottom:  4px;
}
.pin-item:hover { background: var(--surface-2); }

.pin-content { flex: 1; cursor: pointer; overflow: hidden; }
.pin-user    { font-size: 12px; font-weight: 700; color: var(--primary); display: block; }
.pin-text    { font-size: 13px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

.pin-remove {
    color:         var(--text-3);
    font-size:     14px;
    padding:       2px 6px;
    border-radius: var(--radius-sm);
    flex-shrink:   0;
    transition:    all var(--transition);
}
.pin-remove:hover { background: #ff3b30; color: #fff; }

.sidebar-footer {
    padding:      12px;
    border-top:   1px solid var(--border);
    flex-shrink:  0;
}

.wipe-btn {
    width:         100%;
    background:    #ff3b30;
    color:         #fff;
    padding:       12px;
    border-radius: var(--radius-md);
    font-weight:   700;
    font-size:     14px;
    transition:    background var(--transition), transform var(--transition);
}
.wipe-btn:hover  { background: #d63029; }
.wipe-btn:active { transform: scale(0.98); }
.wipe-btn:disabled { opacity: .6; pointer-events: none; }

/* ── Chat ────────────────────────────────────────────────────────────── */
.chat {
    flex:       1;
    overflow-y: auto;
    padding:    12px;
    display:    flex;
    flex-direction: column;
    gap:        4px;
    background: var(--bg);
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

.chat::-webkit-scrollbar        { width: 5px; }
.chat::-webkit-scrollbar-track  { background: transparent; }
.chat::-webkit-scrollbar-thumb  { background: var(--border); border-radius: 3px; }

/* ── Message wrapper ─────────────────────────────────────────────────── */
.msg-wrapper {
    display:        flex;
    align-items:    flex-end;
    gap:            8px;
    max-width:      78%;
    animation:      msgFadeIn 0.2s ease;
}

@keyframes msgFadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
}

.msg-wrapper.mine   { align-self: flex-end; flex-direction: row-reverse; }
.msg-wrapper.theirs { align-self: flex-start; }

/* Depth indentation for reply tree */
.msg-wrapper.depth-1 { margin-left: 20px; max-width: 75%; }
.msg-wrapper.depth-2 { margin-left: 36px; max-width: 72%; }
.msg-wrapper.depth-3 { margin-left: 48px; max-width: 68%; }
.msg-wrapper.depth-4 { margin-left: 56px; max-width: 64%; }

.msg-wrapper.mine.depth-1 { margin-right: 20px; margin-left: 0; }
.msg-wrapper.mine.depth-2 { margin-right: 36px; margin-left: 0; }
.msg-wrapper.mine.depth-3 { margin-right: 48px; margin-left: 0; }

/* ── Avatar ──────────────────────────────────────────────────────────── */
.msg-avatar {
    width:         32px;
    height:        32px;
    border-radius: 50%;
    background:    var(--primary);
    color:         #fff;
    font-weight:   700;
    font-size:     14px;
    display:       flex;
    align-items:   center;
    justify-content: center;
    flex-shrink:   0;
    box-shadow:    var(--shadow-sm);
    text-transform: uppercase;
}

/* ── Bubble ──────────────────────────────────────────────────────────── */
.msg-bubble {
    padding:       10px 14px;
    border-radius: var(--radius-lg);
    background:    var(--bubble-theirs);
    color:         var(--text-theirs);
    box-shadow:    var(--shadow-sm);
    max-width:     100%;
    word-break:    break-word;
    overflow-wrap: anywhere;
    position:      relative;
}

.bubble-mine   { background: var(--bubble-mine); color: var(--text-mine); border-bottom-right-radius: 4px; }
.bubble-theirs { border-bottom-left-radius: 4px; border: 1px solid var(--border); }
.msg-bubble.deleted { opacity: .6; font-style: italic; }

.msg-bubble.flash {
    animation: flashHighlight 1.5s ease;
}
@keyframes flashHighlight {
    0%,100% { box-shadow: var(--shadow-sm); }
    30%     { box-shadow: 0 0 0 3px var(--primary); }
}

/* ── Bubble header ───────────────────────────────────────────────────── */
.msg-header {
    display:       flex;
    align-items:   baseline;
    gap:           6px;
    margin-bottom: 4px;
}

.msg-username { font-size: 12px; font-weight: 700; }
.bubble-mine .msg-username { color: rgba(255,255,255,.9) !important; }

.msg-time    { font-size: 10px; color: var(--text-3); margin-left: auto; flex-shrink: 0; }
.bubble-mine .msg-time { color: rgba(255,255,255,.65); }

.msg-edited  { font-size: 10px; color: var(--text-3); }
.bubble-mine .msg-edited { color: rgba(255,255,255,.6); }

.deleted-text { font-size: 13px; }

/* ── Reply quote ─────────────────────────────────────────────────────── */
.reply-quote {
    display:       flex;
    flex-direction: column;
    gap:           2px;
    padding:       6px 10px;
    margin-bottom: 6px;
    background:    rgba(0,0,0,.06);
    border-radius: var(--radius-sm);
    border-left:   3px solid var(--primary);
    cursor:        pointer;
    transition:    background var(--transition);
    overflow:      hidden;
}
.bubble-mine .reply-quote { background: rgba(255,255,255,.15); border-left-color: rgba(255,255,255,.7); }
.reply-quote:hover { background: rgba(0,0,0,.1); }

.rq-user { font-size: 11px; font-weight: 700; color: var(--primary); }
.bubble-mine .rq-user { color: rgba(255,255,255,.9); }
.rq-text { font-size: 12px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bubble-mine .rq-text { color: rgba(255,255,255,.8); }

/* ── Message content ─────────────────────────────────────────────────── */
.msg-content { font-size: 14px; line-height: 1.5; }
.msg-text    { white-space: pre-wrap; word-break: break-word; }

.msg-img {
    display:       block;
    max-width:     100%;
    max-height:    280px;
    border-radius: var(--radius-sm);
    margin-top:    6px;
    cursor:        pointer;
    object-fit:    cover;
    transition:    transform var(--transition);
}
.msg-img:hover { transform: scale(1.02); }

.msg-video, .msg-audio {
    display:  block;
    width:    100%;
    margin-top: 6px;
    border-radius: var(--radius-sm);
}

.msg-file-link {
    display:         inline-flex;
    align-items:     center;
    gap:             6px;
    padding:         8px 12px;
    margin-top:      6px;
    background:      rgba(0,0,0,.06);
    border-radius:   var(--radius-sm);
    font-size:       13px;
    text-decoration: none;
    transition:      background var(--transition);
}
.bubble-mine .msg-file-link { background: rgba(255,255,255,.2); color: #fff; }
.msg-file-link:hover { background: rgba(0,0,0,.12); }

/* ── Message actions ─────────────────────────────────────────────────── */
.msg-actions {
    display:    flex;
    gap:        4px;
    margin-top: 6px;
    opacity:    0;
    transition: opacity var(--transition);
}
.msg-bubble:hover .msg-actions { opacity: 1; }
.msg-bubble:focus-within .msg-actions { opacity: 1; }

.act-btn {
    font-size:     13px;
    padding:       3px 7px;
    border-radius: var(--radius-sm);
    border:        1px solid rgba(0,0,0,.1);
    color:         var(--text-2);
    transition:    all var(--transition);
    line-height:   1;
}
.bubble-mine .act-btn { border-color: rgba(255,255,255,.25); color: rgba(255,255,255,.85); }
.act-btn:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
.act-del:hover { background: #ff3b30 !important; border-color: #ff3b30 !important; }

/* ── Reply tree connector ────────────────────────────────────────────── */
.replies-tree {
    display:     flex;
    flex-direction: column;
    gap:         4px;
    margin-top:  4px;
    padding-left: 12px;
    border-left: 2px solid var(--border);
    position:    relative;
}

/* ── Reactions ───────────────────────────────────────────────────────── */
.msg-reactions {
    display:   flex;
    flex-wrap: wrap;
    gap:       4px;
    margin-top: 6px;
}

.reaction-pill {
    font-size:     13px;
    padding:       2px 8px;
    border-radius: 20px;
    border:        1px solid var(--border);
    background:    var(--surface);
    color:         var(--text);
    transition:    all var(--transition);
    line-height:   1.4;
}
.reaction-pill:hover   { border-color: var(--primary); background: var(--primary-light); }
.reaction-mine         { border-color: var(--primary); background: var(--primary-light); font-weight: 700; }
.bubble-mine .reaction-pill { background: rgba(255,255,255,.2); border-color: rgba(255,255,255,.3); color: #fff; }

/* Reaction picker popup */
.reaction-picker {
    display:       flex;
    flex-wrap:     wrap;
    gap:           4px;
    padding:       10px;
    background:    var(--surface);
    border:        1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow:    var(--shadow-lg);
    z-index:       5000;
    max-width:     260px;
}

.reaction-option {
    font-size:     22px;
    padding:       4px 6px;
    border-radius: var(--radius-sm);
    transition:    transform var(--transition), background var(--transition);
    line-height:   1;
}
.reaction-option:hover { transform: scale(1.3); background: var(--surface-2); }

/* ── Seen indicator ──────────────────────────────────────────────────── */
.seen-indicator {
    font-size:  10px;
    color:      rgba(255,255,255,.7);
    margin-top: 3px;
    text-align: right;
}

/* ── Typing indicator ────────────────────────────────────────────────── */
.typing-indicator {
    display:     flex;
    align-items: center;
    gap:         8px;
    padding:     8px 16px;
    color:       var(--text-2);
    font-size:   13px;
    flex-shrink: 0;
    height:      36px;
    background:  var(--bg);
    border-top:  1px solid var(--border);
}

.typing-dots {
    display: flex;
    gap:     3px;
    align-items: center;
}
.typing-dots span {
    width:            7px;
    height:           7px;
    border-radius:    50%;
    background:       var(--primary);
    animation:        typingBounce 1.2s infinite;
}
.typing-dots span:nth-child(2) { animation-delay: .2s; }
.typing-dots span:nth-child(3) { animation-delay: .4s; }

@keyframes typingBounce {
    0%,60%,100% { transform: translateY(0); }
    30%         { transform: translateY(-5px); }
}

/* ── Reply tag ───────────────────────────────────────────────────────── */
.reply-tag {
    display:      flex;
    align-items:  center;
    gap:          8px;
    padding:      8px 14px;
    background:   var(--surface);
    border-top:   3px solid var(--primary);
    font-size:    13px;
    color:        var(--text-2);
    flex-shrink:  0;
    animation:    slideUp 0.2s ease;
}
.reply-tag.editing { border-color: #ff9800; }
.reply-tag.editing .reply-tag-icon::before { content: '✏️'; }

@keyframes slideUp {
    from { transform: translateY(8px); opacity: 0; }
    to   { transform: translateY(0);   opacity: 1; }
}

.reply-tag-icon  { font-size: 16px; color: var(--primary); flex-shrink: 0; }
.reply-tag-text  { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.reply-tag-close {
    font-size:     18px;
    color:         var(--text-3);
    padding:       2px 6px;
    border-radius: var(--radius-sm);
    flex-shrink:   0;
    transition:    all var(--transition);
}
.reply-tag-close:hover { background: var(--surface-2); color: var(--text); }

/* ── Input bar ───────────────────────────────────────────────────────── */
.input-bar {
    display:        flex;
    align-items:    center;
    gap:            6px;
    padding:        8px 10px;
    background:     var(--surface);
    border-top:     1px solid var(--border);
    flex-shrink:    0;
    padding-bottom: max(8px, env(safe-area-inset-bottom));
}

.input-username {
    width:       52px;
    padding:     6px 4px;
    border:      none;
    background:  none;
    font-weight: 700;
    font-size:   12px;
    color:       var(--primary);
    text-align:  center;
    flex-shrink: 0;
    min-width:   0;
}
.input-username::placeholder { color: var(--border); }

.upload-btn {
    font-size:     22px;
    padding:       6px;
    border-radius: var(--radius-sm);
    flex-shrink:   0;
    transition:    background var(--transition);
    color:         var(--text-2);
    line-height:   1;
    display:       flex;
    align-items:   center;
}
.upload-btn:hover { background: var(--surface-2); }

.input-message {
    flex:          1;
    padding:       9px 14px;
    border:        1.5px solid var(--border);
    border-radius: var(--radius-xl);
    background:    var(--surface-2);
    font-size:     14px;
    outline:       none;
    resize:        none;
    line-height:   1.4;
    min-width:     0;
    color:         var(--text);
    transition:    border-color var(--transition);
}
.input-message:focus   { border-color: var(--primary); background: var(--surface); }
.input-message::placeholder { color: var(--text-3); }

.send-btn {
    width:          40px;
    height:         40px;
    border-radius:  50%;
    background:     var(--primary);
    color:          #fff;
    font-size:      17px;
    flex-shrink:    0;
    display:        flex;
    align-items:    center;
    justify-content: center;
    transition:     all var(--transition);
    box-shadow:     0 2px 6px rgba(0,132,255,.4);
}
.send-btn:hover  { background: var(--primary-dark); transform: scale(1.05); }
.send-btn:active { transform: scale(0.95); }

/* ── Color dot (user colors) ─────────────────────────────────────────── */
.color-dot {
    width:         20px;
    height:        20px;
    border-radius: 50%;
    background:    var(--primary);
    border:        2px solid var(--border);
    flex-shrink:   0;
    transition:    transform var(--transition);
}
.color-dot:hover { transform: scale(1.2); }

.color-picker-popup {
    display:       flex;
    flex-wrap:     wrap;
    gap:           6px;
    padding:       10px;
    background:    var(--surface);
    border:        1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow:    var(--shadow-lg);
    z-index:       5000;
    width:         200px;
}

.color-swatch {
    width:         28px;
    height:        28px;
    border-radius: 50%;
    border:        2px solid transparent;
    transition:    transform var(--transition), border-color var(--transition);
}
.color-swatch:hover   { transform: scale(1.15); }
.color-swatch.selected { border-color: var(--text); box-shadow: 0 0 0 2px var(--surface), 0 0 0 4px currentColor; }

.color-custom {
    width:    100%;
    height:   32px;
    border:   1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor:   pointer;
}

/* ── Media popup ─────────────────────────────────────────────────────── */
.media-popup {
    position:       fixed;
    inset:          0;
    background:     rgba(0,0,0,.92);
    z-index:        9000;
    display:        none;
    align-items:    center;
    justify-content: center;
    padding:        20px;
}
.media-popup[style*="flex"] { display: flex !important; }

.media-popup-inner {
    background:    var(--surface);
    border-radius: var(--radius-lg);
    padding:       20px;
    width:         100%;
    max-width:     420px;
    display:       flex;
    flex-direction: column;
    gap:           14px;
    animation:     popIn 0.25s ease;
    max-height:    90vh;
    overflow-y:    auto;
}
@keyframes popIn {
    from { opacity: 0; transform: scale(0.92); }
    to   { opacity: 1; transform: scale(1); }
}

.media-popup-title { font-size: 16px; font-weight: 700; text-align: center; }

#pop-img  { max-width: 100%; max-height: 50vh; border-radius: var(--radius-md); object-fit: contain; }
#pop-vid  { max-width: 100%; max-height: 50vh; border-radius: var(--radius-md); }
#pop-aud  { width: 100%; }
.pop-file-info {
    padding:       16px;
    background:    var(--surface-2);
    border-radius: var(--radius-md);
    text-align:    center;
    font-size:     14px;
    color:         var(--text-2);
}

/* Upload progress */
.progress-wrap { background: var(--surface-2); border-radius: 4px; height: 6px; overflow: hidden; }
.progress-bar  { height: 100%; background: var(--primary); width: 0; transition: width 0.2s; border-radius: 4px; }

.pop-caption {
    padding:       9px 12px;
    border:        1.5px solid var(--border);
    border-radius: var(--radius-md);
    font-size:     14px;
    background:    var(--surface-2);
    outline:       none;
}
.pop-caption:focus { border-color: var(--primary); }

.media-popup-actions {
    display:         flex;
    gap:             10px;
    justify-content: center;
}

.btn {
    padding:       10px 28px;
    border-radius: var(--radius-xl);
    font-weight:   700;
    font-size:     14px;
    transition:    all var(--transition);
}
.btn:hover  { transform: scale(1.04); }
.btn:active { transform: scale(0.97); }
.btn-cancel { background: var(--surface-2); color: var(--text); }
.btn-send   { background: var(--primary);   color: #fff; box-shadow: 0 2px 8px rgba(0,132,255,.3); }

/* ── Search ──────────────────────────────────────────────────────────── */
.search-overlay {
    position:       fixed;
    inset:          0;
    background:     rgba(0,0,0,.6);
    z-index:        8000;
    display:        none;
    align-items:    flex-start;
    justify-content: center;
    padding:        60px 16px 16px;
}
.search-overlay[style*="flex"] { display: flex !important; }

.search-panel {
    background:    var(--surface);
    border-radius: var(--radius-lg);
    width:         100%;
    max-width:     520px;
    box-shadow:    var(--shadow-lg);
    overflow:      hidden;
    animation:     slideDown 0.2s ease;
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-12px); }
    to   { opacity: 1; transform: translateY(0); }
}

.search-header {
    display:      flex;
    align-items:  center;
    gap:          10px;
    padding:      12px 16px;
    border-bottom: 1px solid var(--border);
}
.search-icon { font-size: 18px; flex-shrink: 0; }

#search-input {
    flex:        1;
    border:      none;
    background:  none;
    font-size:   15px;
    outline:     none;
    color:       var(--text);
    min-width:   0;
}
#search-input::placeholder { color: var(--text-3); }

.search-close {
    color:         var(--text-2);
    font-size:     18px;
    padding:       4px 8px;
    border-radius: var(--radius-sm);
    transition:    background var(--transition);
}
.search-close:hover { background: var(--surface-2); }

.search-results {
    max-height: 400px;
    overflow-y: auto;
    padding:    8px;
}

.search-hint  { font-size: 13px; color: var(--text-3); text-align: center; padding: 24px; }
.search-empty { font-size: 13px; color: var(--text-3); text-align: center; padding: 24px; }

.search-result-item {
    display:       flex;
    flex-direction: column;
    gap:           2px;
    padding:       10px 12px;
    border-radius: var(--radius-md);
    cursor:        pointer;
    transition:    background var(--transition);
}
.search-result-item:hover { background: var(--surface-2); }

.sr-user { font-size: 11px; font-weight: 700; color: var(--primary); }
.sr-text { font-size: 13px; color: var(--text-2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sr-text mark { background: #fff176; color: #000; border-radius: 2px; padding: 0 1px; }

/* ── Active users widget ─────────────────────────────────────────────── */
.active-users-widget {
    position:      fixed;
    bottom:        max(72px, calc(60px + env(safe-area-inset-bottom)));
    left:          10px;
    display:       flex;
    align-items:   center;
    gap:           5px;
    padding:       5px 10px;
    border-radius: var(--radius-xl);
    font-size:     12px;
    font-weight:   600;
    background:    var(--surface);
    box-shadow:    var(--shadow-md);
    border:        1px solid var(--border);
    z-index:       200;
    pointer-events: none;
    color:         var(--text-2);
}

.presence-dot {
    width:         8px;
    height:        8px;
    border-radius: 50%;
    background:    #4caf50;
    animation:     pulse 2s infinite;
}

@keyframes pulse {
    0%,100% { opacity: 1; }
    50%      { opacity: .5; }
}

.tier-basic  .presence-dot { background: #4caf50; }
.tier-medium .presence-dot { background: #2196f3; }
.tier-max    .presence-dot { background: #9c27b0; }
.tier-ultra  .presence-dot { background: #ff5722; animation: pulse 0.6s infinite; }

/* ── Toast ───────────────────────────────────────────────────────────── */
.toast {
    position:      fixed;
    bottom:        max(80px, calc(70px + env(safe-area-inset-bottom)));
    left:          50%;
    transform:     translateX(-50%) translateY(20px);
    background:    #333;
    color:         #fff;
    padding:       9px 18px;
    border-radius: var(--radius-xl);
    font-size:     13px;
    font-weight:   600;
    z-index:       9999;
    opacity:       0;
    transition:    all 0.3s ease;
    pointer-events: none;
    white-space:   nowrap;
}
.toast.toast-show {
    opacity:   1;
    transform: translateX(-50%) translateY(0);
}

/* ── Accessibility ───────────────────────────────────────────────────── */
:focus-visible {
    outline:        2px solid var(--primary);
    outline-offset: 2px;
}

@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration:   0.01ms !important;
        transition-duration:  0.01ms !important;
    }
}

/* ── Responsive ──────────────────────────────────────────────────────── */
@media (max-width: 480px) {
    .msg-wrapper     { max-width: 90%; }
    .msg-wrapper.depth-1, .msg-wrapper.depth-2,
    .msg-wrapper.depth-3, .msg-wrapper.depth-4 { max-width: 88%; }

    .gate-title    { font-size: 22px; }
    .tier          { padding: 14px 16px; }
    .tier-icon     { font-size: 24px; }

    .input-message { font-size: 16px; } /* prevents iOS zoom */
    .nav-name      { display: none; }
}

/* ── Message timestamp row (full date/time below message content) ─────────── */
.msg-timestamp-row {
    display:    flex;
    justify-content: flex-end;
    margin-top: 4px;
}

.msg-ts-full {
    font-size:  10px;
    color:      var(--text-3);
    line-height: 1.2;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.01em;
}

.bubble-mine .msg-ts-full {
    color: rgba(255,255,255,.55);
}

/* Relative time in header — keep it, style it */
.msg-time {
    font-size:   10px;
    color:       var(--text-3);
    margin-left: auto;
    flex-shrink: 0;
    cursor:      help;        /* shows pointer so user knows to hover for full time */
    white-space: nowrap;
}

.bubble-mine .msg-time {
    color: rgba(255,255,255,.65);
}

/* ── File Card (instant send — no Storage upload) ────────────────────────── */
.file-card {
    margin-top:    6px;
    border-radius: var(--radius-md);
    overflow:      hidden;
    background:    rgba(0,0,0,.05);
    max-width:     260px;
    cursor:        default;
    border:        1px solid rgba(0,0,0,.08);
}
.bubble-mine .file-card {
    background:    rgba(255,255,255,.15);
    border-color:  rgba(255,255,255,.2);
}

/* Thumbnail wrapper */
.file-card-img-wrap {
    position:       relative;
    line-height:    0;
    background:     #000;
}

.file-card-img {
    display:     block;
    width:       100%;
    max-height:  200px;
    object-fit:  cover;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
}

/* Video play button overlay */
.file-card-play {
    position:    absolute;
    inset:       0;
    display:     flex;
    align-items: center;
    justify-content: center;
    font-size:   36px;
    color:       rgba(255,255,255,.9);
    text-shadow: 0 2px 8px rgba(0,0,0,.6);
    pointer-events: none;
}

/* Big icon when no thumbnail */
.file-card-big-icon {
    font-size:   48px;
    text-align:  center;
    padding:     16px;
    line-height: 1;
}

/* Info row */
.file-card-info {
    display:        flex;
    flex-direction: column;
    gap:            2px;
    padding:        8px 10px;
}

.file-card-name {
    font-size:     13px;
    font-weight:   600;
    color:         var(--text);
    white-space:   nowrap;
    overflow:      hidden;
    text-overflow: ellipsis;
    max-width:     220px;
}
.bubble-mine .file-card-name { color: #fff; }

.file-card-meta {
    font-size:  11px;
    color:      var(--text-3);
}
.bubble-mine .file-card-meta { color: rgba(255,255,255,.65); }

/* Preview popup file-card */
.file-card-preview {
    display:     flex;
    align-items: center;
    gap:         12px;
    padding:     10px;
    background:  var(--surface-2);
    border-radius: var(--radius-md);
    border:      1px solid var(--border);
}

.file-card-preview .file-card-thumb {
    width:         64px;
    height:        64px;
    object-fit:    cover;
    border-radius: var(--radius-sm);
    flex-shrink:   0;
}

.file-card-preview .file-card-icon {
    font-size:   40px;
    flex-shrink: 0;
    width:       64px;
    text-align:  center;
}

.file-card-preview .file-card-info {
    display:        flex;
    flex-direction: column;
    gap:            3px;
    min-width:      0;
    padding:        0;
}

.file-card-preview .file-card-name {
    font-size:     14px;
    font-weight:   600;
    overflow:      hidden;
    text-overflow: ellipsis;
    white-space:   nowrap;
    color:         var(--text);
}

.file-card-preview .file-card-meta {
    font-size: 12px;
    color:     var(--text-2);
}

.file-card-badge {
    font-size:     11px;
    color:         #4caf50;
    font-weight:   600;
    margin-top:    2px;
}

/* ── Optimistic UI (WhatsApp-style instant send) ─────────────────────────── */
.msg-wrapper.optimistic .msg-bubble {
    opacity: 0.75;
}
.msg-wrapper.optimistic.pending .msg-bubble {
    animation: pulseSend 1.2s ease infinite;
}
@keyframes pulseSend {
    0%,100% { opacity: 0.75; }
    50%      { opacity: 0.45; }
}
.msg-wrapper.failed .msg-bubble {
    border: 1.5px solid #ff3b30 !important;
    opacity: 1;
}
.msg-status {
    font-size:  11px;
    margin-top: 4px;
    text-align: right;
}
.msg-status.pending { color: rgba(255,255,255,.6); }
.msg-status.failed  { color: #ff6b6b; }
.msg-status.failed button {
    background:    none;
    border:        1px solid #ff6b6b;
    color:         #ff6b6b;
    border-radius: 4px;
    padding:       1px 6px;
    font-size:     11px;
    cursor:        pointer;
    margin-left:   4px;
}
